name: Generate API in the TidalAPI module and create a PR if there are changes

on:
  workflow_dispatch: # manual triggering of this workflow
  push:

permissions:
  contents: write
  pull-requests: write

jobs:
  codegen:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Install OpenAPI Generator via Homebrew
      - name: Install OpenAPI Generator with Homebrew
        run: |
          brew update
          brew install openapi-generator

      - name: Run Code Generation Script
        run: |
          cd ./Sources/TidalAPI/
          chmod +x generate_and_clean.sh
          ./generate_and_clean.sh

      - name: Check for changes in Generated folder
        id: check_for_changes
        run: |
          cd ./Sources/TidalAPI/
          [ -n "$(git status -s Generated)" ] && echo "changes_detected=true" >> "$GITHUB_OUTPUT" || echo "changes_detected=false" >> "$GITHUB_OUTPUT"

      - name: No Changes Found - Say Goodbye
        if: ${{ steps.check_for_changes.outputs.changes_detected == 'false' }}
        run: |
            echo "No changes found. Good bye"

      - name: Commit changes
        if: ${{ steps.check_for_changes.outputs.changes_detected == 'true' }}
        run: |
          git config user.email "svc-github-tidal-music-tools@block.xyz"
          git config user.name "TIDAL Music Tools"
          git checkout -b tidal-music-tools/Update-Tidal-Api
          git add .
          git commit -m "Update TidalAPI with new generated files"
  
      - name: Push changes
        if: ${{ steps.check_for_changes.outputs.changes_detected == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            git push origin tidal-music-tools/Update-Tidal-Api
